/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
-m  -n wikilinks_test_result -e -c wikilinks_test -k /home/ivan_hoe/.ssh/known_hosts
-n 1 asjdkh 12345 35468 p "/media/ivan_hoe/data/documents/0fit/bp/pd_corp/pipeFed.py" /media/ivan_hoe/data/documents/0fit/bp/pd_corp/return /mnt/minerva1/nlp/projects/pd_corp/tmp/ -f  -d  -p
-n 1 knot02.fit.vutbr.cz a:1 12345 35468 s "cat @parallel | wc -c > /media/ivan_hoe/data/documents/0fit/bp/pd_corp/out/@parallel_filename.out" t /mnt/minerva1/nlp/projects/pd_corp/return t /mnt/minerva1/nlp/projects/pd_corp/out/@filename.out /mnt/minerva1/nlp/projects/pd_corp/download -f /home/xstrak25/pd_corp/build/classes/execution/MasterNodeNotificator.class /home/xstrak25/pd_corp/build/classes/local/Init.class /home/xstrak25/pd_corp/build/classes/local/NodeInfo.class /home/xstrak25/pd_corp/build/classes/local/Master.class /home/xstrak25/pd_corp/build/classes/local/Node.class /home/xstrak25/pd_corp/build/classes/local/UserInfoManager.class /home/xstrak25/pd_corp/build/classes/local/SshUser.class /home/xstrak25/pd_corp/build/classes/local/Request.class /home/xstrak25/pd_corp/build/classes/network/NetworkService.class /home/xstrak25/pd_corp/build/classes/network/Data.class /home/xstrak25/pd_corp/build/classes/network/NodeDevice.class /home/xstrak25/pd_corp/build/classes/network/FtpClient.class /home/xstrak25/pd_corp/build/classes/network/Message.class /home/xstrak25/pd_corp/build/classes/parser/XMLConfigParser.class /home/xstrak25/pd_corp/build/classes/parser/FileXML.class /home/xstrak25/pd_corp/build/classes/parser/ArgParse.class /home/xstrak25/pd_corp/build/classes/parser/NodeXML.class /home/xstrak25/pd_corp/build/classes/parser/ParserException.class /home/xstrak25/pd_corp/build.xml /home/xstrak25/pd_corp/dest/lib/commons-io-2.4-javadoc.jar /home/xstrak25/pd_corp/dest/lib/commons-io-2.4.jar /home/xstrak25/pd_corp/dest/lib/ftp4j-1.7.2.jar /home/xstrak25/pd_corp/dest/lib/ftplet-api-1.0.6.jar /home/xstrak25/pd_corp/dest/lib/ftpserver-core-1.0.6.jar /home/xstrak25/pd_corp/dest/lib/jsch-0.1.51.jar /home/xstrak25/pd_corp/dest/lib/mina-core-2.0.4.jar /home/xstrak25/pd_corp/dest/lib/slf4j-api-1.5.2.jar /home/xstrak25/pd_corp/dest/lib/slf4j-simple-1.5.0.jar /home/xstrak25/pd_corp/dest/Pd_corp.jar /home/xstrak25/pd_corp/lib/commons-io-2.4-javadoc.jar /home/xstrak25/pd_corp/lib/commons-io-2.4.jar /home/xstrak25/pd_corp/lib/ftp4j-1.7.2.jar /home/xstrak25/pd_corp/lib/ftplet-api-1.0.6.jar /home/xstrak25/pd_corp/lib/ftpserver-core-1.0.6.jar /home/xstrak25/pd_corp/lib/jsch-0.1.51.jar /home/xstrak25/pd_corp/lib/mina-core-2.0.4.jar /home/xstrak25/pd_corp/lib/slf4j-api-1.5.2.jar /home/xstrak25/pd_corp/lib/slf4j-simple-1.5.0.jar /home/xstrak25/pd_corp/log_1 /home/xstrak25/pd_corp/log_10 /home/xstrak25/pd_corp/log_11 /home/xstrak25/pd_corp/log_12 /home/xstrak25/pd_corp/log_13 /home/xstrak25/pd_corp/log_14 /home/xstrak25/pd_corp/log_15 /home/xstrak25/pd_corp/log_16 /home/xstrak25/pd_corp/log_17 /home/xstrak25/pd_corp/log_18 /home/xstrak25/pd_corp/log_19 /home/xstrak25/pd_corp/log_2 /home/xstrak25/pd_corp/log_20 /home/xstrak25/pd_corp/log_21 /home/xstrak25/pd_corp/log_22 /home/xstrak25/pd_corp/log_23 /home/xstrak25/pd_corp/log_3 /home/xstrak25/pd_corp/log_4 /home/xstrak25/pd_corp/log_5 /home/xstrak25/pd_corp/log_6 /home/xstrak25/pd_corp/log_7 /home/xstrak25/pd_corp/log_8 /home/xstrak25/pd_corp/log_9 /home/xstrak25/pd_corp/src/execution/MasterNodeNotificator.java /home/xstrak25/pd_corp/src/execution/TaskExecutor.java /home/xstrak25/pd_corp/src/execution/TasksManager.java /home/xstrak25/pd_corp/src/local/FileService.java /home/xstrak25/pd_corp/src/local/Init.java /home/xstrak25/pd_corp/src/local/Master.java /home/xstrak25/pd_corp/src/local/Node.java /home/xstrak25/pd_corp/src/local/NodeInfo.java /home/xstrak25/pd_corp/src/local/Request.java /home/xstrak25/pd_corp/src/local/SshUser.java /home/xstrak25/pd_corp/src/local/UserInfoManager.java /home/xstrak25/pd_corp/src/network/Data.java /home/xstrak25/pd_corp/src/network/FtpClient.java /home/xstrak25/pd_corp/src/network/Message.java /home/xstrak25/pd_corp/src/network/NetworkService.java /home/xstrak25/pd_corp/src/network/NodeDevice.java /home/xstrak25/pd_corp/src/parser/ArgParse.java /home/xstrak25/pd_corp/src/parser/FileXML.java /home/xstrak25/pd_corp/src/parser/NodeXML.java /home/xstrak25/pd_corp/src/parser/ParserException.java /home/xstrak25/pd_corp/src/parser/XMLConfigParser.java /home/xstrak25/pd_corp/XML /home/xstrak25/pd_corp/src/local/test.java 

*/
package local;

import ssh.SshExecutorException;
import parser.XMLConfigParser;
import java.io.*;
import static java.lang.System.exit;
import java.util.*;
import network.NetworkService;
import org.apache.ftpserver.*;
import org.apache.ftpserver.ftplet.Authority;
import org.apache.ftpserver.ftplet.UserManager;
import org.apache.ftpserver.listener.ListenerFactory;
import org.apache.ftpserver.usermanager.impl.BaseUser;
import org.apache.ftpserver.usermanager.impl.WritePermission;
import parser.ArgParse;
import parser.ParserException;
import java.util.logging.Handler;
import java.util.logging.Level;
import java.util.logging.Logger;
import org.apache.ftpserver.ftplet.FtpException;
import generator.SshGen;
import java.util.logging.FileHandler;
import java.util.logging.SimpleFormatter;
import javax.xml.parsers.ParserConfigurationException;




public class Main {
    /**
     * @param argV the command line arguments
     */
    
    //todo level, ssh, node diff, hello interval, num of process, task manager ratio
    private static final Logger logger = Logger.getLogger(Main.class.getName());
    public static final Level level = Level.FINE;
    public static final long STARTPHASE_TIMEOUT_MILIS = 120000;
    

    public static void setupLogger(){
        Logger rootLogger = Logger.getLogger("");
        Handler[] r = rootLogger.getHandlers();
        
        r[0].setLevel(Main.level);
        rootLogger.setLevel(Main.level);
    }

    public static void setupLogger(String filename){
        try {
            Logger rootLogger = Logger.getLogger("");
            Handler[] r = rootLogger.getHandlers();
            
            FileHandler fh = new FileHandler(filename);
            fh.setLevel(Main.level);
            fh.setFormatter(new SimpleFormatter());
            rootLogger.addHandler(fh);
            rootLogger.setLevel(Main.level);
            r[0].setLevel(Level.OFF);
        } catch (IOException | SecurityException ex) {
            System.err.println(filename+" error.");
            setupLogger();
        }
    }
    
    
    public static void main(String[] argV){
        try {  
            final long startTime = System.currentTimeMillis();
            final Node localNode;
            final FtpServer ftpServer;
            final int ftpPort;
            final String downloadDest;
            setupLogger();
            
            ArgParse args = new ArgParse(argV);
            NetworkService net = null;
            
            args.parse();
            
            
            ShutdownHook terminationService= new ShutdownHook();
            Runtime.getRuntime().addShutdownHook(terminationService);
            
            if(args.isMaster() && args.isGenerateConfig()){
                new SshGen(args.getRsa(), args.getKnownHosts(), args.getGenerateConfigInput(), args.getGenerateConfigOutput()).generate();
            }
            else{
                if(args.isMaster()){
                    if(args.isHelp()){
                        System.out.print(ArgParse.printHelp());
                        exit(0);
                    }
                    XMLConfigParser parser = new XMLConfigParser(args.getConfig());
                    parser.parse();
                    if(parser.master.logFile != null) {
                        setupLogger(parser.master.logFile);
                    }
                    ftpPort = parser.master.ftpPort;
                    downloadDest = parser.master.downloadDest;
                    localNode = new MasterInitializer(args, parser, terminationService).Prepare();
                }
                
                // slave
                else{
                    if(args.getLogFile() != null) {
                        setupLogger(args.getLogFile());
                    }
                    ftpPort = args.getFtpPort();
                    downloadDest = args.getDownloadDest();
                    localNode = new SlaveInitializer(args, terminationService).Prepare();
                }
                
                if(downloadDest != null) {
                    FileDownload.setDownloadDest(downloadDest);
                }
                if(localNode.isComputing()) {
                    ftpServer = initFtpServer(ftpPort);
                    terminationService.setServer(ftpServer);
                    ftpServer.start();
                }
                
                FileDownload.setUniqID(Node.getID());
                
                localNode.start();
                
                // manual clean
                terminationService.run();
                if(localNode instanceof Master && args.isGeneratingResultConfig()){
                    new ResultGenerator(((Master) localNode).getNodes(), ((Master) localNode).getResults(), args.getGenerateResultConfigFile()).generate();
                }
            }
            
            logger.log(Level.INFO, "Processing time milis:{0}", System.currentTimeMillis() - startTime);
        } catch (ParserException | ParserConfigurationException | SshExecutorException | FtpException | NodeInitializerException | IOException ex) {
            if (ex instanceof ParserException){
                logger.log(Level.INFO, ArgParse.printHelp());
                logger.log(Level.INFO, ex.getMessage());
            }
            else{
                logger.log(Level.SEVERE, ex.getMessage(), ex);
            }
            exit(1);
        }
    }   
    
    /**
     * initialize ftp server
     * @param port
     * @return FtpServer
     * @throws Exception 
     */
    private static FtpServer initFtpServer(int port) throws FtpException{
        FtpServer server;
        
        FtpServerFactory serverFactory = new FtpServerFactory();
        FtpServerFactory ftpServerFactory = new FtpServerFactory();

        ListenerFactory listenerFactory = new ListenerFactory();
        listenerFactory.setPort(port);
        ftpServerFactory.addListener("default", listenerFactory.createListener());

        ConnectionConfigFactory configFactory = new ConnectionConfigFactory();
        //configFactory.setAnonymousLoginEnabled(true);
        configFactory.setMaxLogins(Integer.MAX_VALUE);
        ftpServerFactory.setConnectionConfig(configFactory.createConnectionConfig());
        BaseUser user = new BaseUser();
        user.setName("pd_corp");
        user.setPassword("][[asddddddddddd2j9d8238ud");
        user.setHomeDirectory("/");
       

        List<Authority> authorities = new ArrayList<>(1);
        authorities.add(new WritePermission());
        user.setAuthorities(authorities);
        UserManager userManager = ftpServerFactory.getUserManager();
        userManager.save(user);

        server = ftpServerFactory.createServer();
        return server;
    }
}
   
